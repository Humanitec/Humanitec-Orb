description: >
  Build image and push to Humanitec
parameters:
  module_name:
    description: "Name of the module"
    type: string
    default: $CIRCLE_PROJECT_REPONAME
  organization:
    description: "Name of the organization in Humanitec"
    type: string
    default: ""
  humanitec_api:
    description: "URL of the Humanitec API"
    type: string
    default: "api.humanitec.io"
executor: default
steps:
  # Get Humanitec registry credentials using the HUMANITEC_TOKEN
  # provided for the CircleCI integration
  - get-registry-credentials:
      humanitec_api: << parameters.humanitec_api >>
      organization: << parameters.organization >>
  # Build the image,  tag it, and push it to the Humanitec registry
  - build-tag-and-push-image:
      local_tag: "'<< parameters.organization >>'/'<< parameters.module_name >>':'$CIRCLE_BUILD_NUM'"
      remote_tag: "'$HUMANITEC_REGISTRY_URL'/'<< parameters.organization >>'/'<< parameters.module_name >>':'$CIRCLE_BUILD_NUM'"
  # Inform Humanitec about new available image
  - inform-humanitec: 
      remote_tag: "'$HUMANITEC_REGISTRY_URL'/'<< parameters.organization >>'/'<< parameters.module_name >>':'$CIRCLE_BUILD_NUM'"
      organization: << parameters.organization >>
      humanitec_api: << parameters.humanitec_api >>